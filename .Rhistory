y=difference_of_mean_riders, fill=col), position = "dodge")
ggplot(data=usage_demographic_type) +
geom_bar(stat="identity", aes(x=is_viable_route,
y=difference_of_mean_riders, fill=col), position = "dodge")
ggplot(data=usage_demographic_type) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=col),
position = "dodge")
#' ride data cleaning
#'
#' @description prepares ridership data for use in analysis
#' @param ridership_df read in a suitable data frame of ridership data for the transit system
#' @return an organized data frame with Date, Hour, and Time variables.
ride_data_cleaning <- function(ridership_df){
cleaned_ridership_df <- ridership_df %>%
#find the date
mutate(Time = mdy_hm(Time)) %>%
mutate(Date = date(Time), Hour = hour(Time)) %>%
#select only necessary columns for analysis: we don't need the pass type
#for this
select(c(Date, Hour, Time, Route, Trip, Stop.Number, Trip, Source, Type, College,
High.School, Low.Income, Eco.Pass, Card.Number))
return(cleaned_ridership_df)
}
ridership_df <- read.csv("/Users/juliadubnoff/Downloads/ridership_simulated.csv")
otp_df <- read.csv("/Users/juliadubnoff/Downloads/otp_simulated.csv")
#run through event_analaysis
occurrences <- as.character(c("2024-05-01", "2024-05-08", "2024-05-15", "2024-05-22", "2024-05-29"))
cleaned_ridership_df <- ride_data_cleaning(ridership_df)
#testing/running code
#load libraries
library(tidyverse)
#for haversine:
library(pracma)
library(ggplot2)
cleaned_ridership_df <- ride_data_cleaning(ridership_df)
route_extraction <- function(otp_df, occurrences){
#check to see format of occurrences
if (!is.character(occurrences)){
break("Occurrences must be a character")
}
#filter to make the data set only include routes on the days of occurrence
routes_df <- otp_df %>%
filter(Date %in% occurrences) %>%
#select only necessary columns for the scheduled routes of a day
select(c(Date, Route, Trip, Stop, Stop.Sequence, Scheduled.Time, StopLat, StopLng))
return(routes_df)
}
routes_df <- route_extraction(otp_df, occurrences)
event_lat <- 41.85480685417614
event_long <- -71.39157664680116
max_distance <- 0.8
viable_routes <- location_analysis(routes_df, event_lat, event_long, max_distance)
#default max_distance value =0.8 km that designates the radius from an event that a
#stop could be
find_nearby_stops <- function(routes_df, event_lat, event_long, max_distance){
#get a more concise list of stops
stops<-routes_df %>%
group_by(Route, Stop) %>%
summarize(StopLat=mean(StopLat), StopLng=mean(StopLng))
#create dataframe of nearby_stops
nearby_stops<-data.frame("Route" = "temp", "Stop" = "temp",
"StopLat" = "temp", "StopLng" ="temp")
#cycle through all stops with haversine,
#find all that are within the distance from the event
for(i in 1:nrow(stops)){
#if not NA values
if(!is.na(stops$StopLat[i]) & !is.na(stops$StopLng[i])){
distance_to_event <- haversine(c(stops$StopLat[i], stops$StopLng[i]),
c(event_lat, event_long))
#evaluate distance
if (distance_to_event<=max_distance){
nearby_stops <- nearby_stops %>%
rbind(stops[i, ])
}
}
}
#remove temp line
nearby_stops <- nearby_stops %>%
filter(Route!="temp")
return(nearby_stops)
}
nearby_stops <- find_nearby_stops(routes_df, event_lat, event_long, max_distance)
#find which routes are viable
viable_routes<-unique(nearby_stops$Route)
usage_demographics <- function (ridership_df, col, viable_routes, occurances){
#quote column
col <- enquo(col)
#demographic_variable should be a string corresponding to a column name
#sum ridership over hour, then take the mean
route_usage <- ridership_df %>%
#quote column
group_by(Date, Hour, Route, !!col) %>%
summarize(sum_riders=n()) %>%
ungroup()%>%
#categorize whether the events are in the occurrences
mutate(event_day=case_when(Date %in% occurrences ~ 1, TRUE ~ 0)) %>%
group_by(Route, event_day, !!col) %>%
summarize(mean_riders=mean(sum_riders)) %>%
pivot_wider(names_from=event_day, values_from = mean_riders, names_prefix = "mean_riders_") %>%
#evaluate how much ridership changes between event day and non event day for route
mutate(difference_of_mean_riders=mean_riders_1-mean_riders_0) %>%
#remove NA entries
filter(!is.na(difference_of_mean_riders)) %>%
#create entry to designate if nearby route
mutate(is_viable_route = case_when( Route %in% viable_routes ~ "Yes", TRUE ~ "No"))%>%
mutate(col = as.factor(!!col))%>%
mutate(is_viable_route=as.factor(is_viable_route))
return(route_usage)
}
usage_demographic_type <- usage_demographics(ridership_df, Type, viable_routes, occurances)
usage_demographic_type <- usage_demographics(cleaned_ridership_df, Type, viable_routes, occurances)
ggplot(data=usage_demographic_type) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=col),
position = "dodge") +
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, by Type of Rider" ) +
theme_minimal() +
theme(axis.text.x = element_blank(), axis.ticks.x=element_blank())
ggplot(data=usage_demographic_type) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=Type),
position = "dodge") +
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.text.x = element_blank(), axis.ticks.x=element_blank())
ggplot(data=usage_demographic_type) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=Type),
position = "dodge") +
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.text.x = element_blank(), axis.ticks.x=element_blank()) +
scale_y_continuous(limits = c(-50, 300))
ggplot(data=usage_demographic_type) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=Type),
position = "dodge") +
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.text.x = element_blank(), axis.ticks.x=element_blank())
ggplot(data=usage_demographic_type) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=Type),
position = "dodge") +
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.text.x = element_blank(), axis.ticks.x=element_blank()) +
scale_y_continuous(limits = c(-50, 300))
ggplot(data=usage_demographic_type) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=Type))+
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.text.x = element_blank(), axis.ticks.x=element_blank()) +
scale_y_continuous(limits = c(-50, 300))
ggplot(data=usage_demographic_type) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=Type))+
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.ticks.x=element_blank()) +
scale_y_continuous(limits = c(-50, 300))
ggplot(data=usage_demographic_type) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=Type))+
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.ticks.x=element_blank()) +
scale_y_continuous(limits = c(-50, 340))
usage_demographic_college <- usage_demographics(ridership_df, College, viable_routes, occurances)
usage_demographic_college <- usage_demographics(cleaned_ridership_df, College, viable_routes, occurances)
ggplot(data=usage_demographic_college) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=Type))+
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.ticks.x=element_blank()) +
scale_y_continuous(limits = c(-50, 340))
usage_demographic_college <- usage_demographics(cleaned_ridership_df, College, viable_routes, occurances)
ggplot(data=usage_demographic_college) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=College))+
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By College" ) +
theme_minimal() +
theme(axis.ticks.x=element_blank()) +
scale_y_continuous(limits = c(-50, 340))
usage_demographic_highschool <- usage_demographics(cleaned_ridership_df, High.School, viable_routes, occurances)
ggplot(data=usage_demographic_highschool) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=High.School))+
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.ticks.x=element_blank()) +
scale_y_continuous(limits = c(-50, 340))
usage_demographic_lowinc <- usage_demographics(cleaned_ridership_df, Low.Income, viable_routes, occurances)
ggplot(data=usage_demographic_lowinc) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=Low.Income))+
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.ticks.x=element_blank()) +
scale_y_continuous(limits = c(-50, 340))
event_analysis <- function (otp_df, ridership_df, occurrences,
start_time, end_time, event_lat, event_long, max_distance=0.8) {
#check to see format of occurrences
if (!is.character(occurrences)){
break("Occurrences must be a character")
}
# clean ridership data
ridership_df <- ride_data_cleaning(ridership_df)
#extract routes
routes_df <- route_extraction(otp_df, occurrences)
#find which stops are viable to the event through location_analysis function
nearby_stops <- find_nearby_stops(routes_df, event_lat, event_long, max_distance)
#find which routes are viable
viable_routes<-unique(nearby_stops$Route)
#change in route usage during event:
route_usage_df <- route_usage(ridership_df, viable_routes, occurances)
test_general<-t.test(data=route_usage_df, difference_of_mean_riders~is_viable_route, alternative="two.sided")
#next step: visuals
general_boxplot<-ggplot(data=route_usage_df) +
geom_boxplot(aes(group=is_viable_route, y=difference_of_mean_riders, fill=is_viable_route)) +
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days" ) +
theme_minimal() +
theme(axis.text.x = element_blank(), axis.ticks.x=element_blank())
#demographic analysis of type of rider, college association, high school association, income level
#much of this is not known but we can analysis change accross these demographics for what is recorded
usage_demographic_type <- usage_demographics(ridership_df, Type, viable_routes, occurances)
boxplot_by_type<-ggplot(data=usage_demographic_type) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=Type))+
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.ticks.x=element_blank()) +
scale_y_continuous(limits = c(-50, 340))
return(list(test = test_general, general_boxplot= general_boxplot,
boxplot_by_type = boxplot_by_type))
}
View(otp_df)
View(usage_demographic_type)
View(ridership_df)
source("data_cleaning.R", "route_extraction.R", "find_nearby_stops.R",
"route_usage.R", "usage_demographic.R")
source("data_cleaning.R", "route_extraction.R", "find_nearby_stops.R",
"route_usage.R", "usage_demographic.R", local=FALSE)
source("data_cleaning.R", "route_extraction.R", "find_nearby_stops.R",
"route_usage.R", "usage_demographic.R", local=FALSE, echo=TRUE)
event_analysis <- function (otp_df, ridership_df, occurrences,
event_lat, event_long, max_distance=0.8) {
#check to see format of occurrences
if (!is.character(occurrences)){
break("Occurrences must be a character")
}
# clean ridership data
ridership_df <- ride_data_cleaning(ridership_df)
#extract routes that have somen occurrences on event days
routes_df <- route_extraction(otp_df, occurrences)
#find which stops are viable to the event through location_analysis function
nearby_stops <- find_nearby_stops(routes_df, event_lat, event_long,
max_distance)
#find which routes are viable
viable_routes<-unique(nearby_stops$Route)
#change in route usage during event:
route_usage_df <- route_usage(ridership_df, viable_routes, occurances)
#calculate the general t-test
test_general<-t.test(data=route_usage_df,
difference_of_mean_riders~is_viable_route,
alternative="two.sided")
#next step: visuals
general_boxplot<-ggplot(data=route_usage_df) +
geom_boxplot(aes(group=is_viable_route, y=difference_of_mean_riders,
fill=is_viable_route)) +
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days" ) +
theme_minimal() +
theme(axis.text.x = element_blank(), axis.ticks.x=element_blank())
#demographic analysis of type of rider. this could be edited to evaluate other
#demographics
usage_demographic_type <- usage_demographics(ridership_df, Type,
viable_routes, occurances)
boxplot_by_type<-ggplot(data=usage_demographic_type) +
geom_boxplot(aes(x=is_viable_route,
y=difference_of_mean_riders, fill=Type))+
labs(y="Increase of Riders on Days of Event",
title="Routes' Usage Change On Event Days, By Type of Rider" ) +
theme_minimal() +
theme(axis.ticks.x=element_blank()) +
scale_y_continuous(limits = c(-50, 340))
return(list(test = test_general, general_boxplot= general_boxplot,
boxplot_by_type = boxplot_by_type))
}
source("data_cleaning.R", "route_extraction.R", "find_nearby_stops.R",
"route_usage.R", "usage_demographic.R", local=FALSE, echo=TRUE)
list_files <- c("data_cleaning.R", "route_extraction.R", "find_nearby_stops.R",
"route_usage.R", "usage_demographic.R")
sapply(list_files, source)
list_files <- c("data_cleaning.R", "route_extraction.R", "find_nearby_stops.R",
"route_usage.R", "usage_demographic.R")
list_files <- c("data_cleaning.R", "route_extraction.R", "find_nearby_stops.R",
"route_usage.R", "usage_demographic.R")
setwd("/Users/juliadubnoff/Documents/GitHub/Final-Project")
setwd("/Users/juliadubnoff/Documents/GitHub/Final-Project")
list_files <- c("data_cleaning.R", "route_extraction.R", "find_nearby_stops.R",
"route_usage.R", "usage_demographic.R")
sapply(list_files, source)
list_files <- c("data_cleaning.R", "route_extraction.R", "find_nearby_stops.R",
"route_usage.R", "usage_demographics.R")
sapply(list_files, source)
setwd("/Users/juliadubnoff/Documents/GitHub/Final-Project")
list_files <- c("data_cleaning.R", "route_extraction.R", "find_nearby_stops.R",
"route_usage.R", "usage_demographics.R")
source("~/Documents/GitHub/Final-Project/event_analysis.R", echo = TRUE)
source("~/Documents/GitHub/Final-Project/full_run_through_test.R", echo = TRUE)
#full_run_through_test
setwd("/Users/juliadubnoff/Documents/GitHub/Final-Project")
source("event_analysis.R")
#load libraries
library(tidyverse)
#for haversine:
library(pracma)
library(ggplot2)
#read in data
ridership_df <- read.csv("/Users/juliadubnoff/Downloads/ridership_simulated.csv")
otp_df <- read.csv("/Users/juliadubnoff/Downloads/otp_simulated.csv")
#weekly occurrences starting from first of may as a starting point
occurrences <- as.character(c("2024-05-01", "2024-05-08", "2024-05-15",
"2024-05-22", "2024-05-29"))
#set event latitude and longitude based on Lippitt Memorial
#Park, where the farmers market is
event_lat<-41.79829
event_long<-71.41475
event_analysis(otp_df, ridership_df, occurrences,
event_lat, event_long, max_distance=0.8)
library(dplyr)
event_analysis(otp_df, ridership_df, occurrences,
event_lat, event_long, max_distance=0.8)
rlang::last_trace()
View(ridership_df)
setwd("/Users/juliadubnoff/Documents/GitHub/Final-Project")
event_analysis(otp_df, ridership_df, occurrences,
event_lat, event_long, max_distance=0.8)
cleaned_ridership_df <- ride_data_cleaning(ridership_df)
routes_df <- route_extraction(otp_df, occurrences)
nearby_stops <- find_nearby_stops(routes_df, event_lat, event_long,
max_distance)
nearby_stops <- find_nearby_stops(routes_df, event_lat, event_long,
max_distance=0.8)
viable_routes<-unique(nearby_stops$Route)
route_usage_df <- route_usage(cleaned_ridership_df, viable_routes, occurances)
View(cleaned_ridership_df)
#'
#' @description finds a data frame of stops and their associated details that
#' are near to the event in question
#' @param cleaned_ridership_df ridership_df as cleaned by data cleaning function
#' @param viable_routes vector containing all routes that have stops near enough
#' to event
#' @param occurrences list of days in which the event in question occurs
#'
#' @return data frame that can be used in tests and graphs evaluating how much
#' ridership changes on event days versus non event days.
route_usage <- function(cleaned_ridership_df, viable_routes, occurances) {
route_usage <- cleaned_ridership_df %>%
#sum ridership over hour
group_by(Date, Hour, Route) %>%
summarize(sum_riders=n()) %>%
ungroup()%>%
#categorize whether the events are in the occurrences
mutate(event_day=case_when(Date %in% occurrences ~ 1, TRUE ~ 0)) %>%
group_by(Route, event_day) %>%
summarize(mean_riders=mean(sum_riders)) %>%
pivot_wider(names_from=event_day, values_from = mean_riders, names_prefix =
"mean_riders_") %>%
#evaluate how much ridership changes between event day and non event day
#for route
mutate(difference_of_mean_riders=mean_riders_1-mean_riders_0) %>%
#remove NA entries
filter(!is.na(difference_of_mean_riders)) %>%
#create entry to designate if nearby route
mutate(is_viable_route = case_when( Route %in% viable_routes ~ "Yes",
TRUE ~ "No")) %>%
#convert category is_viable_route to factor
mutate(is_viable_route=as.factor(is_viable_route))
return(route_usage)
}
route_usage_df <- route_usage(cleaned_ridership_df, viable_routes, occurances)
setwd("/Users/juliadubnoff/Documents/GitHub/Final-Project")
source("~/Documents/GitHub/Final-Project/R Scripts/event_analysis.R", echo = TRUE)
event_analysis(otp_df, ridership_df, occurrences,
event_lat, event_long, max_distance=0.8)
t.test(data=route_usage_df,
difference_of_mean_riders~is_viable_route,
alternative="two.sided")
#'
#' @description finds a data frame of stops and their associated details that
#' are near to the event in question
#' @param cleaned_ridership_df ridership_df as cleaned by data cleaning function
#' @param viable_routes vector containing all routes that have stops near enough
#' to event
#' @param occurrences list of days in which the event in question occurs
#'
#' @return data frame that can be used in tests and graphs evaluating how much
#' ridership changes on event days versus non event days.
route_usage <- function(cleaned_ridership_df, viable_routes, occurances) {
route_usage <- cleaned_ridership_df %>%
#sum ridership over hour
group_by(Date, Hour, Route) %>%
summarize(sum_riders=n()) %>%
ungroup()%>%
#categorize whether the events are in the occurrences
mutate(event_day=case_when(Date %in% occurrences ~ 1, TRUE ~ 0)) %>%
group_by(Route, event_day) %>%
summarize(mean_riders=mean(sum_riders)) %>%
pivot_wider(names_from=event_day, values_from = mean_riders, names_prefix =
"mean_riders_") %>%
#evaluate how much ridership changes between event day and non event day
#for route
mutate(difference_of_mean_riders=mean_riders_1-mean_riders_0) %>%
#remove NA entries
filter(!is.na(difference_of_mean_riders)) %>%
#create entry to designate if nearby route
mutate(is_viable_route = case_when( Route %in% viable_routes ~ "Yes",
TRUE ~ "No")) %>%
#convert category is_viable_route to factor
mutate(is_viable_route=as.factor(is_viable_route))  %>%
return(route_usage)
}
cleaned_ridership_df <- ride_data_cleaning(ridership_df)
routes_df <- route_extraction(otp_df, occurrences)
nearby_stops <- find_nearby_stops(routes_df, event_lat, event_long,
max_distance=0.8)
viable_routes<-unique(nearby_stops$Route)
route_usage_df <- route_usage(cleaned_ridership_df, viable_routes, occurances)
#'
#' @description finds a data frame of stops and their associated details that
#' are near to the event in question
#' @param cleaned_ridership_df ridership_df as cleaned by data cleaning function
#' @param viable_routes vector containing all routes that have stops near enough
#' to event
#' @param occurrences list of days in which the event in question occurs
#'
#' @return data frame that can be used in tests and graphs evaluating how much
#' ridership changes on event days versus non event days.
route_usage <- function(cleaned_ridership_df, viable_routes, occurances) {
route_usage <- cleaned_ridership_df %>%
#sum ridership over hour
group_by(Date, Hour, Route) %>%
summarize(sum_riders=n()) %>%
ungroup()%>%
#categorize whether the events are in the occurrences
mutate(event_day=case_when(Date %in% occurrences ~ 1, TRUE ~ 0)) %>%
group_by(Route, event_day) %>%
summarize(mean_riders=mean(sum_riders)) %>%
pivot_wider(names_from=event_day, values_from = mean_riders, names_prefix =
"mean_riders_") %>%
#evaluate how much ridership changes between event day and non event day
#for route
mutate(difference_of_mean_riders=mean_riders_1-mean_riders_0) %>%
#remove NA entries
filter(!is.na(difference_of_mean_riders)) %>%
#create entry to designate if nearby route
mutate(is_viable_route = case_when( !(Route %in% viable_routes) ~ "No",
TRUE ~ "No")) %>%
#convert category is_viable_route to factor
mutate(is_viable_route=as.factor(is_viable_route))  %>%
return(route_usage)
}
viable_routes<-unique(nearby_stops$Route)
View(route_usage_df)
nearby_stops <- find_nearby_stops(routes_df, event_lat, event_long,
max_distance=0.8)
#extract routes that have somen occurrences on event days
routes_df <- route_extraction(otp_df, occurrences)
max_distance=0.8
#find which stops are viable to the event through location_analysis function
nearby_stops <- find_nearby_stops(routes_df, event_lat, event_long,
max_distance)
nearby_stops <- find_nearby_stops(routes_df, event_lat, event_long,
max_distance)
stops<-routes_df %>%
group_by(Route, Stop) %>%
summarize(StopLat=mean(StopLat), StopLng=mean(StopLng))
#create data frame of nearby_stops
nearby_stops<-data.frame("Route" = "temp", "Stop" = "temp",
"StopLat" = "temp", "StopLng" ="temp")
for(i in 1:nrow(stops)){
#if not NA values
if(!is.na(stops$StopLat[i]) & !is.na(stops$StopLng[i])){
distance_to_event <- haversine(c(stops$StopLat[i], stops$StopLng[i]),
c(event_lat, event_long))
#evaluate distance
if (distance_to_event<=max_distance){
nearby_stops <- nearby_stops %>%
rbind(stops[i, ])
}
}
}
View(stops)
